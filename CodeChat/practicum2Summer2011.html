<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=None">
  <style type="text/css">
td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; margin: 0px; min-height: 1em }
body .hll { background-color: #ffffcc }
body .c { font-family: sans-serif; white-space: normal; font-size: small; display: inline-block; width: 5.5in; color: #408080 } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .cm { color: #408080 } /* Comment.Multiline */
body .cp { color: #BC7A00 } /* Comment.Preproc */
body .c1 { font-family: sans-serif; white-space: normal; font-size: small; display: inline-block; width: 5.5in; color: #408080 } /* Comment.Single */
body .cs { color: #408080 } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #FF0000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #00A000 } /* Generic.Inserted */
body .go { color: #808080 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0040D0 } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #7D9029 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #999999; font-weight: bold } /* Name.Entity */
body .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #A0A000 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #BB6688 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body><pre><span class="c1">"Copyright (c) 2008 Robert B. Reese, Bryan A. Jones, J. W. Bruce ("AUTHORS")"<br />
All rights reserved.<br />
&nbsp; (R. Reese, reese_AT_ece.msstate.edu, Mississippi State University)<br />
&nbsp; (B. A. Jones, bjones_AT_ece.msstate.edu, Mississippi State University)<br />
&nbsp; (J. W. Bruce, jwbruce_AT_ece.msstate.edu, Mississippi State University)<br />
<br />
Permission to use, copy, modify, and distribute this software and its
documentation for any purpose, without fee, and without written agreement is
hereby granted, provided that the above copyright notice, the following
two paragraphs and the authors appear in all copies of this software.<br />
<br />
IN NO EVENT SHALL THE "AUTHORS" BE LIABLE TO ANY PARTY FOR
DIRECT, INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES ARISING OUT
OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN IF THE "AUTHORS"
HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.<br />
<br />
THE "AUTHORS" SPECIFICALLY DISCLAIMS ANY WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS FOR A PARTICULAR PURPOSE. THE SOFTWARE PROVIDED HEREUNDER IS
ON AN "AS IS" BASIS, AND THE "AUTHORS" HAS NO OBLIGATION TO
PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.<br />
<br />
Please maintain this header in its entirety when copying/modifying
these files.</span></pre>
<pre></pre>
<pre><span class="c1">This file provdies a solution to practicum 2. The program consists of two sections: configuration and body code.<br /></span></pre>
<pre></pre>
<pre><span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">Dummy declaration to make the lexer happy</span></pre>
<pre><span class="cp">#include &lt;pic24_all.h&gt;</span></pre>
<pre><span class="cp">#include &lt;dataXfer.h&gt;</span></pre>
<pre></pre>
<pre><span class="c1"><h2>Motors</h2>
Use RB0 and RB1 to control motor direction</span></pre>
<pre><span class="kt">void</span> <span class="nf">config_motor_dir</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span></pre>
<pre>  <span class="n">CONFIG_RB0_AS_DIG_OUTPUT</span><span class="p">();</span></pre>
<pre>  <span class="n">CONFIG_RB1_AS_DIG_OUTPUT</span><span class="p">();</span></pre>
<pre><span class="p">}</span></pre>
<pre></pre>
<pre><span class="c1">This enum gives directions for the motor, per the table below. set_motor_dir directly assigning these values to RB1:0 to set motor direction. <br /></span></pre>
<pre><span class="k">enum</span> <span class="p">{</span> </pre>
<pre>  <span class="n">MOTOR_STOPL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>   <span class="c1">stop with both outputs low</span></pre>
<pre>  <span class="n">MOTOR_CW</span><span class="p">,</span>          <span class="c1">clockwise</span></pre>
<pre>  <span class="n">MOTOR_CCW</span><span class="p">,</span>         <span class="c1">counterclockwise</span></pre>
<pre>  <span class="n">MOTOR_STOPH</span>        <span class="c1">stop with both outputs high</span></pre>
<pre><span class="p">};</span></pre>
<pre></pre>
<pre><span class="c1">Specify the motor's direction. The speed is controlled separately
by the PWM.<br /></span></pre>
<pre><span class="kt">void</span> <span class="nf">set_motor_dir</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">u16_dir</span><span class="p">)</span> <span class="p">{</span> </pre>
<pre>  <span class="c1">Make sure we've passed a valid motor direction </span></pre>
<pre>  <span class="n">ASSERT</span><span class="p">(</span><span class="n">u16_dir</span> <span class="o">&lt;=</span> <span class="n">MOTOR_STOPH</span><span class="p">);</span></pre>
<pre>  <span class="n">_RB0</span> <span class="o">=</span> <span class="n">u16_dir</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span></pre>
<pre>  <span class="n">_RB1</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16_dir</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span></pre>
<pre><span class="p">}</span></pre>
<pre></pre>
<pre><span class="c1"><h2>State machine</h2>
The state machine is given below.<br />
<img src="practicum2Summer2011_fsm.png" /><br />
<br />
This enum specifies the state machine state shown in the diagram above.<br /></span></pre>
<pre><span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span></pre>
<pre>  <span class="n">MOTOR_ON_WFP</span><span class="p">,</span>	<span class="c1">The motor is on, we're waiting for a pushbutton press (WFP)</span></pre>
<pre>  <span class="n">MOTOR_OFF_WFR</span><span class="p">,</span>        <span class="c1">The motor is off, we're waiting for a pushbutton release (WFR)</span></pre>
<pre>  <span class="n">MOTOR_OFF_WFP</span><span class="p">,</span>        <span class="c1">The motor is off, we're waiting for a pushbutton release (WFR)</span></pre>
<pre>  <span class="n">MOTOR_ON_WFR</span><span class="p">,</span>         <span class="c1">The motor is on, we're waiting for a pushbutton release (WFR)</span></pre>
<pre>  <span class="n">MAX_STATE</span>             <span class="c1">This specifies the maximum allowable value for the state. but is not a valid state.</span></pre>
<pre><span class="p">}</span> <span class="n">STATE</span><span class="p">;</span></pre>
<pre></pre>
<pre><span class="c1">This stores the state. It's volatile so it can be accessed in the ISR and in main().</span></pre>
<pre><span class="k">volatile</span> <span class="n">STATE</span> <span class="n">e_state</span> <span class="o">=</span> <span class="n">MOTOR_ON_WFP</span><span class="p">;</span></pre>
<pre></pre>
<pre><span class="c1">This array assigns human-readable names to the states.</span></pre>
<pre><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">apsz_state</span><span class="p">[</span><span class="n">MAX_STATE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span></pre>
<pre>  <span class="s">&quot;MOTOR_ON_WFP&quot;</span><span class="p">,</span></pre>
<pre>  <span class="s">&quot;MOTOR_OFF_WFR&quot;</span><span class="p">,</span></pre>
<pre>  <span class="s">&quot;MOTOR_OFF_WFP&quot;</span><span class="p">,</span></pre>
<pre>  <span class="s">&quot;MOTOR_ON_WFR&quot;</span></pre>
<pre><span class="p">};</span></pre>
<pre></pre>
<pre><span class="c1"><h3>Pushbutton</h3>
Configure the pushbutton. Since it's a SPST connected between the PIC's
pin and groud, enable a pullup and wait for the pullup to take effect
before proceeding.<br /></span></pre>
<pre><span class="kt">void</span> <span class="nf">config_pb</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span></pre>
<pre>  <span class="n">CONFIG_RB13_AS_DIG_INPUT</span><span class="p">();</span></pre>
<pre>  <span class="n">ENABLE_RB13_PULLUP</span><span class="p">();</span></pre>
<pre>  <span class="n">DELAY_US</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span></pre>
<pre><span class="p">}</span></pre>
<pre></pre>
<pre><span class="cp">// Define a macro which is true when the pushbutton is pressed.</span></pre>
<pre><span class="cp">#define PB_PRESSED() (_RB13 == 0)</span></pre>
<pre></pre>
<pre><span class="c1"><h3>LED</h3>
The LED requires only a digital output.</span></pre>
<pre><span class="kt">void</span> <span class="nf">config_led</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span></pre>
<pre> <span class="n">CONFIG_RB9_AS_DIG_OUTPUT</span><span class="p">();</span></pre>
<pre><span class="p">}</span></pre>
<pre></pre>
<pre><span class="cp">// Define it using _LAT, not _R, so it can be toggled.</span></pre>
<pre><span class="cp">#define LED (_LATB9)</span></pre>
<pre></pre>
<pre><span class="cp">// &lt;h2&gt;Pulse width modulation&lt;/h2&gt;</span></pre>
<pre><span class="cp">// In thie section, timer 2 and the output compare module are used to</span></pre>
<pre><span class="cp">// produce a PWM waveform.</span></pre>
<pre><span class="cp">#ifndef PWM_PERIOD</span></pre>
<pre><span class="cp">#define PWM_PERIOD 1000 </span><span class="c1">desired period, in us</span></pre>
<pre><span class="cp">#endif</span></pre>
<pre></pre>
<pre><span class="c1">Set up timer 2 to produce an interrupt every PWM_PERIOD us.</span></pre>
<pre><span class="kt">void</span>  <span class="nf">configTimer2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span></pre>
<pre>  <span class="n">T2CON</span> <span class="o">=</span> <span class="n">T2_OFF</span> <span class="o">|</span> <span class="n">T2_IDLE_CON</span> <span class="o">|</span> <span class="n">T2_GATE_OFF</span></pre>
<pre>          <span class="o">|</span> <span class="n">T2_32BIT_MODE_OFF</span></pre>
<pre>          <span class="o">|</span> <span class="n">T2_SOURCE_INT</span></pre>
<pre>          <span class="o">|</span> <span class="n">T2_PS_1_8</span><span class="p">;</span></pre>
<pre>  <span class="n">PR2</span> <span class="o">=</span> <span class="n">usToU16Ticks</span><span class="p">(</span><span class="n">PWM_PERIOD</span><span class="p">,</span> <span class="n">getTimerPrescale</span><span class="p">(</span><span class="n">T2CONbits</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span></pre>
<pre>  <span class="n">TMR2</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>       <span class="c1">clear timer2 value</span></pre>
<pre>  <span class="n">_T2IF</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre>
<pre>  <span class="n">_T2IP</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre>
<pre>  <span class="n">_T2IE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>    <span class="c1">enable the Timer2 interrupt</span></pre>
<pre><span class="p">}</span></pre>
<pre></pre>
<pre></pre>
<pre><span class="kt">void</span> <span class="nf">configOutputCapture1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span></pre>
<pre>  <span class="n">T2CONbits</span><span class="p">.</span><span class="n">TON</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>       <span class="c1">disable Timer when configuring Output compare</span></pre>
<pre>  <span class="n">CONFIG_OC1_TO_RP</span><span class="p">(</span><span class="mi">14</span><span class="p">);</span>        <span class="c1">map OC1 to RP14/RB14</span></pre>
<pre>  <span class="c1">assumes TIMER2 initialized before OC1 so PRE bits are set</span></pre>
<pre>  <span class="n">OC1RS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">initially off</span></pre>
<pre>  <span class="c1">turn on the compare toggle mode using Timer2</span></pre>
<pre>  <span class="n">OC1CON</span> <span class="o">=</span> <span class="n">OC_TIMER2_SRC</span> <span class="o">|</span>     <span class="c1">Timer2 source</span></pre>
<pre>           <span class="n">OC_PWM_FAULT_PIN_DISABLE</span><span class="p">;</span>  <span class="c1">PWM, no fault detection</span></pre>
<pre><span class="p">}</span></pre>
<pre></pre>
<pre><span class="kt">void</span> <span class="n">_ISR</span> <span class="nf">_T2Interrupt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span></pre>
<pre>  <span class="n">_T2IF</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="c1">clear the timer interrupt bit</span></pre>
<pre></pre>
<pre>  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">e_state</span> <span class="o">==</span> <span class="n">MOTOR_ON_WFP</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">e_state</span> <span class="o">==</span> <span class="n">MOTOR_ON_WFR</span><span class="p">))</span> <span class="p">{</span></pre>
<pre>    <span class="kt">int32_t</span> <span class="n">i32_temp</span><span class="p">;</span></pre>
<pre>    <span class="c1">update the PWM duty cycle from the ADC value</span></pre>
<pre>    <span class="n">i32_temp</span> <span class="o">=</span> <span class="n">ADC1BUF0</span><span class="p">;</span>  <span class="c1">use 32-bit value for range</span></pre>
<pre>    <span class="c1">compute new pulse width that is 0 to 99% of PR2
    pulse width (PR2) * ADC/4096</span></pre>
<pre>    <span class="n">i32_temp</span> <span class="o">=</span> <span class="p">(((</span><span class="n">i32_temp</span> <span class="o">-</span> <span class="mi">2048</span><span class="p">)</span><span class="o">*</span><span class="n">PR2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">);</span></pre>
<pre>    <span class="k">if</span> <span class="p">(</span><span class="n">i32_temp</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre>
<pre>      <span class="n">OC1RS</span> <span class="o">=</span> <span class="n">i32_temp</span><span class="p">;</span>  <span class="c1">update pulse width value</span></pre>
<pre>      <span class="n">set_motor_dir</span><span class="p">(</span><span class="n">MOTOR_CW</span><span class="p">);</span></pre>
<pre>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre>
<pre>      <span class="n">OC1RS</span> <span class="o">=</span> <span class="o">-</span><span class="n">i32_temp</span><span class="p">;</span>  <span class="c1">update pulse width value</span></pre>
<pre>      <span class="n">set_motor_dir</span><span class="p">(</span><span class="n">MOTOR_CCW</span><span class="p">);</span></pre>
<pre>    <span class="p">}</span></pre>
<pre>    <span class="n">SET_SAMP_BIT_ADC1</span><span class="p">();</span>      <span class="c1">start sampling and conversion</span></pre>
<pre>  <span class="p">}</span></pre>
<pre></pre>
<pre>  <span class="c1">State machine</span></pre>
<pre>  <span class="k">switch</span> <span class="p">(</span><span class="n">e_state</span><span class="p">)</span> <span class="p">{</span></pre>
<pre>    <span class="k">case</span> <span class="n">MOTOR_ON_WFP</span> :</pre>
<pre>      <span class="k">if</span> <span class="p">(</span><span class="n">PB_PRESSED</span><span class="p">())</span> <span class="p">{</span></pre>
<pre>        <span class="n">e_state</span> <span class="o">=</span> <span class="n">MOTOR_OFF_WFR</span><span class="p">;</span></pre>
<pre>        <span class="n">OC1RS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre>
<pre>      <span class="p">}</span></pre>
<pre>      <span class="k">break</span><span class="p">;</span></pre>
<pre></pre>
<pre>    <span class="k">case</span> <span class="n">MOTOR_OFF_WFR</span> :</pre>
<pre>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PB_PRESSED</span><span class="p">())</span> <span class="p">{</span></pre>
<pre>        <span class="n">e_state</span> <span class="o">=</span> <span class="n">MOTOR_OFF_WFP</span><span class="p">;</span></pre>
<pre>      <span class="p">}</span></pre>
<pre>      <span class="k">break</span><span class="p">;</span></pre>
<pre></pre>
<pre>    <span class="k">case</span> <span class="n">MOTOR_OFF_WFP</span> :</pre>
<pre>      <span class="k">if</span> <span class="p">(</span><span class="n">PB_PRESSED</span><span class="p">())</span> <span class="p">{</span></pre>
<pre>        <span class="n">e_state</span> <span class="o">=</span> <span class="n">MOTOR_ON_WFR</span><span class="p">;</span></pre>
<pre>      <span class="p">}</span></pre>
<pre>      <span class="k">break</span><span class="p">;</span></pre>
<pre></pre>
<pre>    <span class="k">case</span> <span class="n">MOTOR_ON_WFR</span> :</pre>
<pre>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PB_PRESSED</span><span class="p">())</span> <span class="p">{</span></pre>
<pre>        <span class="n">e_state</span> <span class="o">=</span> <span class="n">MOTOR_ON_WFP</span><span class="p">;</span></pre>
<pre>      <span class="p">}</span></pre>
<pre>      <span class="k">break</span><span class="p">;</span></pre>
<pre></pre>
<pre>    <span class="k">default</span> <span class="o">:</span></pre>
<pre>      <span class="n">ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span></pre>
<pre>  <span class="p">}</span></pre>
<pre><span class="p">}</span></pre>
<pre></pre>
<pre><span class="c1">/ Indexes of all the variables to be transferred.</span></pre>
<pre><span class="k">enum</span> <span class="p">{</span> <span class="n">U32_PW_NDX</span><span class="p">,</span> <span class="n">OC1RS_NDX</span><span class="p">,</span> <span class="n">ADC1BUF0_NDX</span> <span class="p">};</span></pre>
<pre></pre>
<pre></pre>
<pre><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span></pre>
<pre>  <span class="kt">uint32_t</span> <span class="n">u32_pw</span><span class="p">;</span></pre>
<pre>  <span class="n">STATE</span> <span class="n">e_last_state</span> <span class="o">=</span> <span class="n">MAX_STATE</span><span class="p">;</span></pre>
<pre></pre>
<pre>  <span class="c1">Initialize</span></pre>
<pre>  <span class="n">configBasic</span><span class="p">(</span><span class="n">HELLO_MSG</span><span class="p">);</span></pre>
<pre>  <span class="n">initDataXfer</span><span class="p">();</span></pre>
<pre></pre>
<pre>  <span class="c1">All variables received by the PIC must be specified.
  Params:  Index         Variable  PC can change  Format  Description</span></pre>
<pre>  <span class="n">SPECIFY_VAR</span><span class="p">(</span><span class="n">U32_PW_NDX</span><span class="p">,</span>   <span class="n">u32_pw</span><span class="p">,</span>   <span class="n">FALSE</span><span class="p">,</span>         <span class="s">&quot;%u&quot;</span><span class="p">,</span>   <span class="s">&quot;PWM pulse width (us)&quot;</span><span class="p">);</span></pre>
<pre>  <span class="n">SPECIFY_VAR</span><span class="p">(</span><span class="n">OC1RS_NDX</span><span class="p">,</span>    <span class="n">OC1RS</span><span class="p">,</span>    <span class="n">FALSE</span><span class="p">,</span>         <span class="s">&quot;%hu&quot;</span><span class="p">,</span>  <span class="s">&quot;Raw PWM value&quot;</span><span class="p">);</span></pre>
<pre>  <span class="n">SPECIFY_VAR</span><span class="p">(</span><span class="n">ADC1BUF0_NDX</span><span class="p">,</span> <span class="n">ADC1BUF0</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span>         <span class="s">&quot;%hu&quot;</span><span class="p">,</span>  <span class="s">&quot;Raw ADC value&quot;</span><span class="p">);</span></pre>
<pre></pre>
<pre>  <span class="c1">Configure motors</span></pre>
<pre>  <span class="n">configTimer2</span><span class="p">();</span></pre>
<pre>  <span class="n">configOutputCapture1</span><span class="p">();</span></pre>
<pre>  <span class="n">CONFIG_AN0_AS_ANALOG</span><span class="p">();</span></pre>
<pre>  <span class="n">configADC1_ManualCH0</span><span class="p">(</span> <span class="n">ADC_CH0_POS_SAMPLEA_AN0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span></pre>
<pre>  <span class="n">SET_SAMP_BIT_ADC1</span><span class="p">();</span>      <span class="c1">start sampling and conversion</span></pre>
<pre>  <span class="n">T2CONbits</span><span class="p">.</span><span class="n">TON</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>       <span class="c1">turn on Timer2 to start PWM</span></pre>
<pre>  <span class="n">config_motor_dir</span><span class="p">();</span></pre>
<pre></pre>
<pre>  <span class="n">config_pb</span><span class="p">();</span></pre>
<pre>  <span class="n">config_led</span><span class="p">();</span></pre>
<pre></pre>
<pre>  <span class="c1">Report results only</span></pre>
<pre>  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre>
<pre>    <span class="n">u32_pw</span> <span class="o">=</span> <span class="n">ticksToUs</span><span class="p">(</span><span class="n">OC1RS</span><span class="p">,</span> <span class="n">getTimerPrescale</span><span class="p">(</span><span class="n">T2CONbits</span><span class="p">));</span></pre>
<pre>    <span class="n">sendVar</span><span class="p">(</span><span class="n">U32_PW_NDX</span><span class="p">);</span></pre>
<pre>    <span class="n">sendVar</span><span class="p">(</span><span class="n">OC1RS_NDX</span><span class="p">);</span></pre>
<pre>    <span class="n">sendVar</span><span class="p">(</span><span class="n">ADC1BUF0_NDX</span><span class="p">);</span></pre>
<pre></pre>
<pre>    <span class="k">if</span> <span class="p">(</span><span class="n">e_state</span> <span class="o">!=</span> <span class="n">e_last_state</span><span class="p">)</span> <span class="p">{</span></pre>
<pre>      <span class="n">e_last_state</span> <span class="o">=</span> <span class="n">e_state</span><span class="p">;</span></pre>
<pre>      <span class="n">ASSERT</span><span class="p">(</span><span class="n">e_state</span> <span class="o">&lt;</span> <span class="n">MAX_STATE</span><span class="p">);</span></pre>
<pre>      <span class="n">outString</span><span class="p">(</span><span class="n">apsz_state</span><span class="p">[</span><span class="n">e_state</span><span class="p">]);</span></pre>
<pre>      <span class="n">outString</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre>
<pre>    <span class="p">}</span></pre>
<pre></pre>
<pre>    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">e_state</span> <span class="o">==</span> <span class="n">MOTOR_OFF_WFP</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">e_state</span> <span class="o">==</span> <span class="n">MOTOR_OFF_WFR</span><span class="p">)</span> <span class="p">)</span></pre>
<pre>      <span class="n">LED</span> <span class="o">=</span> <span class="o">!</span><span class="n">LED</span><span class="p">;</span></pre>
<pre></pre>
<pre>    <span class="n">DELAY_MS</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span></pre>
<pre>    <span class="n">doHeartbeat</span><span class="p">();</span></pre>
<pre>  <span class="p">}</span></pre>
<pre><span class="p">}</span></pre>
</body>
</html>
